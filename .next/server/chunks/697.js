exports.id=697,exports.ids=[697],exports.modules={66946:(a,b,c)=>{"use strict";Object.defineProperty(b,"I",{enumerable:!0,get:function(){return g}});let d=c(30898),e=c(42471),f=c(47912);async function g(a,b,c,g){if((0,d.isNodeNextResponse)(b)){var h;b.statusCode=c.status,b.statusMessage=c.statusText;let d=["set-cookie","www-authenticate","proxy-authenticate","vary"];null==(h=c.headers)||h.forEach((a,c)=>{if("x-middleware-set-cookie"!==c.toLowerCase())if("set-cookie"===c.toLowerCase())for(let d of(0,f.splitCookiesString)(a))b.appendHeader(c,d);else{let e=void 0!==b.getHeader(c);(d.includes(c.toLowerCase())||!e)&&b.appendHeader(c,a)}});let{originalResponse:i}=b;c.body&&"HEAD"!==a.method?await (0,e.pipeToNodeResponse)(c.body,i,g):i.end()}}},78335:()=>{},84138:(a,b,c)=>{"use strict";c.d(b,{JZ:()=>x});var d=c(55511),e=c.n(d);let f={FACEBOOK:{maxRequests:200,windowMs:36e5,platform:"FACEBOOK"},INSTAGRAM:{maxRequests:200,windowMs:36e5,platform:"INSTAGRAM"},LINKEDIN:{maxRequests:100,windowMs:864e5,platform:"LINKEDIN"},TWITTER:{maxRequests:300,windowMs:9e5,platform:"TWITTER"},TIKTOK:{maxRequests:100,windowMs:36e5,platform:"TIKTOK"}};class g extends Error{constructor(a,b,c,d){super(a),this.platform=b,this.statusCode=c,this.retryAfter=d,this.name="SocialMediaApiError"}}class h extends g{constructor(a,b){super(`Rate limit exceeded for ${a}`,a,429,b),this.name="RateLimitExceededError"}}class i{constructor(a,b){this.config=a,this.platform=b}handleApiError(a,b){if("RATE_LIMIT_EXCEEDED"===a.code)throw new h(this.platform,a.retryAfter||3600);throw new g(`${this.platform} API error during ${b}: ${a.message}`,this.platform,a.statusCode)}async checkRateLimit(){f[this.platform]}}class j extends i{constructor(a){super(a,"FACEBOOK"),this.baseUrl="https://graph.facebook.com/v18.0"}async validateConfig(){try{return(await fetch(`${this.baseUrl}/me?access_token=${this.config.accessToken}`)).ok}catch(a){return!1}}async testConnection(){try{return await this.checkRateLimit(),(await fetch(`${this.baseUrl}/me?fields=id,name&access_token=${this.config.accessToken}`)).ok}catch(a){this.handleApiError(a,"connection test")}}async captureLeads(a){try{await this.checkRateLimit();let b=await fetch(`${this.baseUrl}/${this.config.appId}/leadgen_forms?access_token=${this.config.accessToken}`);if(!b.ok)throw Error(`Failed to fetch lead forms: ${b.statusText}`);let c=await b.json(),d=[];for(let b of c.data||[]){let c=await fetch(`${this.baseUrl}/${b.id}/leads?access_token=${this.config.accessToken}${a?`&filtering=[{field:"time_created",operator:"GREATER_THAN",value:${Math.floor(a.getTime()/1e3)}}]`:""}`);if(c.ok)for(let a of(await c.json()).data||[]){let c={platform:"FACEBOOK",formId:b.id,adId:a.ad_id,campaignId:a.campaign_id,metadata:{leadId:a.id,formName:b.name,createdTime:a.created_time,fieldData:a.field_data}};for(let b of a.field_data||[])switch(b.name.toLowerCase()){case"email":c.email=b.values[0];break;case"full_name":case"name":c.name=b.values[0];break;case"phone_number":case"phone":c.phone=b.values[0];break;case"company_name":case"company":c.company=b.values[0];break;case"message":c.message=b.values[0]}d.push(c)}}return d}catch(a){this.handleApiError(a,"lead capture")}}async getInteractions(a,b){try{return await this.checkRateLimit(),[]}catch(a){this.handleApiError(a,"interaction fetching")}}}class k extends i{constructor(a){super(a,"INSTAGRAM"),this.baseUrl="https://graph.facebook.com/v18.0"}async validateConfig(){try{return(await fetch(`${this.baseUrl}/${this.config.businessAccountId}?fields=id,username&access_token=${this.config.accessToken}`)).ok}catch(a){return!1}}async testConnection(){try{return await this.checkRateLimit(),(await fetch(`${this.baseUrl}/${this.config.businessAccountId}?fields=id,username,name&access_token=${this.config.accessToken}`)).ok}catch(a){this.handleApiError(a,"connection test")}}async captureLeads(a){return[]}async getInteractions(a,b){try{await this.checkRateLimit();let a=await fetch(`${this.baseUrl}/${this.config.businessAccountId}/media?fields=id,media_type,timestamp,like_count,comments_count&access_token=${this.config.accessToken}${b?`&since=${Math.floor(b.getTime()/1e3)}`:""}`);if(!a.ok)throw Error(`Failed to fetch media: ${a.statusText}`);let c=await a.json(),d=[];for(let a of c.data||[])a.like_count>0&&d.push({platform:"INSTAGRAM",type:"SOCIAL_LIKE",externalId:a.id,metadata:{mediaType:a.media_type,timestamp:a.timestamp,likeCount:a.like_count},timestamp:new Date(a.timestamp).getTime()});return d}catch(a){this.handleApiError(a,"interaction fetching")}}}class l extends i{constructor(a){super(a,"LINKEDIN"),this.baseUrl="https://api.linkedin.com/v2"}async validateConfig(){try{return(await fetch(`${this.baseUrl}/me`,{headers:{Authorization:`Bearer ${this.config.accessToken}`,"X-Restli-Protocol-Version":"2.0.0"}})).ok}catch(a){return!1}}async testConnection(){try{return await this.checkRateLimit(),(await fetch(`${this.baseUrl}/me`,{headers:{Authorization:`Bearer ${this.config.accessToken}`,"X-Restli-Protocol-Version":"2.0.0"}})).ok}catch(a){this.handleApiError(a,"connection test")}}async captureLeads(a){try{await this.checkRateLimit();let a=await fetch(`${this.baseUrl}/adForms`,{headers:{Authorization:`Bearer ${this.config.accessToken}`,"X-Restli-Protocol-Version":"2.0.0"}});if(!a.ok)throw Error(`Failed to fetch LinkedIn forms: ${a.statusText}`);return[]}catch(a){this.handleApiError(a,"lead capture")}}async getInteractions(a,b){try{return await this.checkRateLimit(),[]}catch(a){this.handleApiError(a,"interaction fetching")}}}class m{constructor(a){this.config=a,this.services=new Map,this.initializeServices()}initializeServices(){this.config.facebook&&this.services.set("FACEBOOK",new j(this.config.facebook)),this.config.instagram&&this.services.set("INSTAGRAM",new k(this.config.instagram)),this.config.linkedin&&this.services.set("LINKEDIN",new l(this.config.linkedin))}async testAllConnections(){let a={};for(let[b,c]of this.services)try{a[b]=await c.testConnection()}catch(c){a[b]=!1}return a}async captureAllLeads(a){let b=[];for(let[c,d]of this.services)try{let c=await d.captureLeads(a);b.push(...c)}catch(a){console.error(`Error capturing leads from ${c}:`,a)}return b}async getContactInteractions(a,b,c){let d=[];if(b&&this.services.has(b)){let e=this.services.get(b);try{let b=await e.getInteractions(a,c);d.push(...b)}catch(a){console.error(`Error fetching interactions from ${b}:`,a)}}else for(let[b,e]of this.services)try{let b=await e.getInteractions(a,c);d.push(...b)}catch(a){console.error(`Error fetching interactions from ${b}:`,a)}return d}}class n{constructor(){this.config=null}static getInstance(){return n.instance||(n.instance=new n),n.instance}setConfig(a){this.config=a}getConfig(){if(!this.config)throw Error("Social media configuration not initialized");return this.config}isConfigured(){return null!==this.config}}class o{constructor(a){this.ctx=a}async processLeadCaptureData(a){try{if(a.email){let b=await this.ctx.db.query("contacts").withIndex("by_email",b=>b.eq("email",a.email)).first();if(b)return await this.createLeadCaptureInteraction(b._id,a),await this.ctx.db.patch(b._id,{lastInteractionAt:Date.now(),updatedAt:Date.now()}),b._id}let b={name:a.name||"Unknown Lead",email:a.email||"",phone:a.phone,company:a.company,leadSource:a.platform,leadHeat:"COLD",leadHeatScore:5,status:"UNQUALIFIED",notes:a.message,socialProfiles:a.platform?[{platform:a.platform,profileUrl:"",isConnected:!0,lastSyncAt:Date.now()}]:[],customFields:{leadCaptureSource:a.platform,formId:a.formId,adId:a.adId,campaignId:a.campaignId,...a.metadata},createdAt:Date.now(),updatedAt:Date.now(),lastInteractionAt:Date.now()},c=await this.ctx.db.insert("contacts",b);return await this.createLeadCaptureInteraction(c,a),c}catch(a){return console.error("Error processing lead capture data:",a),null}}async createLeadCaptureInteraction(a,b){await this.ctx.db.insert("interactions",{contactId:a,type:"INFO_REQUEST",platform:b.platform,description:`Lead captured from ${b.platform}${b.formId?` (Form: ${b.formId})`:""}`,metadata:{leadCaptureData:b,source:"social_media_api"},createdAt:Date.now()})}async batchProcessLeads(a){let b=0,c=0,d=0,e=0;for(let f of a)try{let a=f.email?await this.ctx.db.query("contacts").withIndex("by_email",a=>a.eq("email",f.email)).first():null;await this.processLeadCaptureData(f)?(b++,a?d++:c++):e++}catch(a){e++,console.error("Error processing lead:",a)}return{processed:b,created:c,updated:d,errors:e}}}class p{constructor(a){this.ctx=a}async syncContactInteractions(a,b,c){try{let d=n.getInstance();if(!d.isConfigured())throw Error("Social media configuration not available");let e=new m(d.getConfig()),f=await e.getContactInteractions(a,b,c),g=0,h=0;for(let b of f)try{await this.createInteractionFromSocialData(a,b),g++}catch(a){h++,console.error("Error creating interaction:",a)}if(g>0){let b=f.reduce((a,b)=>b.timestamp>a.timestamp?b:a);await this.ctx.db.patch(a,{lastInteractionAt:b.timestamp,updatedAt:Date.now()}),await this.recalculateContactHeatScore(a)}return{synced:g,errors:h}}catch(a){return console.error("Error syncing interactions:",a),{synced:0,errors:1}}}async createInteractionFromSocialData(a,b){await this.ctx.db.query("interactions").filter(c=>c.and(c.eq(c.field("contactId"),a),c.eq(c.field("metadata.externalId"),b.externalId))).first()||await this.ctx.db.insert("interactions",{contactId:a,type:b.type,platform:b.platform,description:b.content||`${b.type} on ${b.platform}`,metadata:{externalId:b.externalId,userId:b.userId,userHandle:b.userHandle,source:"social_media_sync",originalData:b.metadata},createdAt:b.timestamp})}async recalculateContactHeatScore(a){let b=await this.ctx.db.query("interactions").withIndex("by_contact",b=>b.eq("contactId",a)).collect(),c={SOCIAL_FOLLOW:1,SOCIAL_LIKE:1,SOCIAL_COMMENT:2,SOCIAL_MESSAGE:3,WEBSITE_VISIT:2,INFO_REQUEST:5,PRICE_QUOTE:8,SITE_VISIT:10,EMAIL_OPEN:1,EMAIL_CLICK:2,PHONE_CALL:5,MEETING:8,OTHER:1},d=b.reduce((a,b)=>a+(c[b.type]||0),0),e="COLD";d>=16?e="HOT":d>=6&&(e="WARM"),await this.ctx.db.patch(a,{leadHeatScore:d,leadHeat:e,updatedAt:Date.now()})}async syncAllContactsInteractions(a,b){let c=await this.ctx.db.query("contacts").collect(),d=0,e=0,f=0;for(let g of c){if(b&&!g.socialProfiles?.some(a=>a.platform===b))continue;d++;let c=await this.syncContactInteractions(g._id,b,a);e+=c.synced,f+=c.errors}return{totalContacts:d,totalSynced:e,totalErrors:f}}}class q{constructor(a){this.ctx=a,this.socialManager=null,this.leadProcessor=new o(a),this.interactionSync=new p(a)}getSocialManager(){if(!this.socialManager){let a=n.getInstance();if(!a.isConfigured())throw Error("Social media configuration not initialized");this.socialManager=new m(a.getConfig())}return this.socialManager}async initializeConfiguration(a){n.getInstance().setConfig(a),this.socialManager=new m(a)}async testPlatformConnections(){try{let a=this.getSocialManager();return await a.testAllConnections()}catch(a){throw new g("Failed to test platform connections","FACEBOOK")}}async captureLeadsFromAllPlatforms(a){try{let b=this.getSocialManager(),c=await b.captureAllLeads(a);if(0===c.length)return{leads:[],processed:0,created:0,updated:0,errors:0};let d=await this.leadProcessor.batchProcessLeads(c);return{leads:c,...d}}catch(a){throw new g("Failed to capture leads","FACEBOOK")}}async syncContactInteractions(a,b,c){return await this.interactionSync.syncContactInteractions(a,b,c)}async syncAllInteractions(a,b){return await this.interactionSync.syncAllContactsInteractions(a,b)}async getPlatformStatus(){try{let a=await this.testPlatformConnections(),b={},c=0;for(let[d,e]of Object.entries(a))b[d]={connected:e,lastSync:new Date},e&&c++;return{platforms:b,totalConnected:c}}catch(a){throw new g("Failed to get platform status","FACEBOOK")}}}class r{static verifyFacebookSignature(a,b,c){let d="sha256="+e().createHmac("sha256",c).update(a).digest("hex");return e().timingSafeEqual(Buffer.from(b),Buffer.from(d))}static verifyInstagramSignature(a,b,c){return this.verifyFacebookSignature(a,b,c)}static verifyLinkedInSignature(a,b,c){let d=e().createHmac("sha256",c).update(a).digest("hex");return e().timingSafeEqual(Buffer.from(b),Buffer.from(d))}}class s{constructor(a,b){this.platform=a,this.integrationService=new q(b)}async handleWebhook(a,b){try{let c=await a.text(),d=a.headers.get("X-Hub-Signature-256")||a.headers.get("X-LinkedIn-Signature")||"";if(!this.verifySignature(c,d,b))return{success:!1,message:"Invalid signature"};let e=JSON.parse(c);return await this.processWebhook(e),{success:!0,message:"Webhook processed successfully"}}catch(a){return console.error(`${this.platform} webhook error:`,a),{success:!1,message:`Webhook processing failed: ${a}`}}}}class t extends s{constructor(a){super("FACEBOOK",a)}verifySignature(a,b,c){return r.verifyFacebookSignature(a,b,c)}async processWebhook(a){if("page"===a.object)for(let b of a.entry){if(b.changes)for(let a of b.changes)"leadgen"===a.field?await this.processLeadGeneration(a.value):"feed"===a.field&&await this.processFeedInteraction(a.value);if(b.messaging)for(let a of b.messaging)await this.processMessage(a)}}async processLeadGeneration(a){try{a.field_data?.find(a=>"full_name"===a.name)?.values[0],a.field_data?.find(a=>"email"===a.name)?.values[0],a.field_data?.find(a=>"phone_number"===a.name)?.values[0],a.field_data?.find(a=>"message"===a.name)?.values[0],a.form_id,a.ad_id,a.campaign_id,a.leadgen_id,a.created_time,a.field_data,await this.integrationService.captureLeadsFromAllPlatforms()}catch(a){console.error("Error processing Facebook lead generation:",a)}}async processFeedInteraction(a){try{let b=this.mapFeedActionToInteractionType(a.verb);b&&console.log(`Facebook feed interaction: ${b}`,a)}catch(a){console.error("Error processing Facebook feed interaction:",a)}}async processMessage(a){try{if(a.message){let b={platform:"FACEBOOK",type:"SOCIAL_MESSAGE",externalId:a.message.mid,userId:a.sender.id,content:a.message.text,metadata:{messageId:a.message.mid,senderId:a.sender.id,recipientId:a.recipient.id},timestamp:a.timestamp};console.log("Facebook message received:",b)}}catch(a){console.error("Error processing Facebook message:",a)}}mapFeedActionToInteractionType(a){switch(a){case"like":return"SOCIAL_LIKE";case"comment":return"SOCIAL_COMMENT";case"share":return"OTHER";default:return null}}}class u extends s{constructor(a){super("INSTAGRAM",a)}verifySignature(a,b,c){return r.verifyInstagramSignature(a,b,c)}async processWebhook(a){if("instagram"===a.object){for(let b of a.entry)if(b.changes)for(let a of b.changes)switch(a.field){case"comments":await this.processComment(a.value);break;case"mentions":await this.processMention(a.value);break;case"story_insights":await this.processStoryInsight(a.value)}}}async processComment(a){try{let b={platform:"INSTAGRAM",type:"SOCIAL_COMMENT",externalId:a.comment_id,userId:a.user_id,content:a.text,metadata:{mediaId:a.media_id,commentId:a.comment_id,userId:a.user_id},timestamp:Date.now()};console.log("Instagram comment received:",b)}catch(a){console.error("Error processing Instagram comment:",a)}}async processMention(a){try{let b={platform:"INSTAGRAM",type:"SOCIAL_COMMENT",externalId:a.comment_id||a.media_id,userId:a.user_id,metadata:{mediaId:a.media_id,userId:a.user_id,mentionType:"story_mention"},timestamp:Date.now()};console.log("Instagram mention received:",b)}catch(a){console.error("Error processing Instagram mention:",a)}}async processStoryInsight(a){try{console.log("Instagram story insight:",a)}catch(a){console.error("Error processing Instagram story insight:",a)}}}class v extends s{constructor(a){super("LINKEDIN",a)}verifySignature(a,b,c){return r.verifyLinkedInSignature(a,b,c)}async processWebhook(a){switch(a.eventType){case"MEMBER_ENGAGEMENT":await this.processMemberEngagement(a.data);break;case"LEAD_EVENT":await this.processLeadEvent(a.data);break;case"MESSAGE_EVENT":await this.processMessageEvent(a.data)}}async processMemberEngagement(a){try{let b=this.mapLinkedInActionToInteractionType(a.action);if(b){let c={platform:"LINKEDIN",type:b,externalId:a.entityUrn,userId:a.memberUrn,metadata:{action:a.action,entityUrn:a.entityUrn,memberUrn:a.memberUrn},timestamp:Date.now()};console.log("LinkedIn engagement received:",c)}}catch(a){console.error("Error processing LinkedIn member engagement:",a)}}async processLeadEvent(a){try{let b={platform:"LINKEDIN",name:a.firstName+" "+a.lastName,email:a.emailAddress,phone:a.phoneNumber,company:a.companyName,metadata:{leadUrn:a.entityUrn,formUrn:a.formUrn,campaignUrn:a.campaignUrn}};console.log("LinkedIn lead captured:",b)}catch(a){console.error("Error processing LinkedIn lead event:",a)}}async processMessageEvent(a){try{let b={platform:"LINKEDIN",type:"SOCIAL_MESSAGE",externalId:a.messageUrn,userId:a.senderUrn,content:a.messageText,metadata:{messageUrn:a.messageUrn,conversationUrn:a.conversationUrn,senderUrn:a.senderUrn},timestamp:Date.now()};console.log("LinkedIn message received:",b)}catch(a){console.error("Error processing LinkedIn message event:",a)}}mapLinkedInActionToInteractionType(a){switch(a){case"LIKE":return"SOCIAL_LIKE";case"COMMENT":return"SOCIAL_COMMENT";case"SHARE":return"OTHER";case"FOLLOW":return"SOCIAL_FOLLOW";default:return null}}}class w{static createHandler(a,b){switch(a){case"FACEBOOK":return new t(b);case"INSTAGRAM":return new u(b);case"LINKEDIN":return new v(b);default:throw Error(`Unsupported webhook platform: ${a}`)}}}class x{constructor(a){this.ctx=a,this.handlers=new Map}registerHandler(a){let b=w.createHandler(a,this.ctx);this.handlers.set(a,b)}async handleWebhook(a,b,c){let d=this.handlers.get(a);return d?await d.handleWebhook(b,c):{success:!1,message:`No handler registered for platform: ${a}`}}async verifyWebhook(a,b,c){let d=new URL(b.url);switch(a){case"FACEBOOK":case"INSTAGRAM":let e=d.searchParams.get("hub.mode"),f=d.searchParams.get("hub.verify_token"),g=d.searchParams.get("hub.challenge");if("subscribe"===e&&f===c)return{success:!0,challenge:g||"",message:"Verification successful"};return{success:!1,message:"Verification failed"};case"LINKEDIN":return{success:!0,message:"LinkedIn webhook verified"};default:return{success:!1,message:`Unsupported platform: ${a}`}}}}},96487:()=>{},96559:(a,b,c)=>{"use strict";a.exports=c(44870)}};