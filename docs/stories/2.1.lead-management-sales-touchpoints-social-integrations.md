# Story 2.1: Lead Management, Sales Touchpoints & Social Integrations

## Status

Approved

## Story

**As a** sales team member,
**I want** comprehensive lead management with rich data, dynamic lead heat indicators, and social media channel integration,
**so that** I can effectively track, nurture, and convert leads through personalized engagement strategies across multiple touchpoints.

## Acceptance Criteria

1. **Lead Data Enrichment System**

   - Implement comprehensive lead profile with custom fields, social media profiles, and interaction history
   - Create dynamic lead heat calculation based on engagement metrics and social interactions
   - Support lead source tracking from multiple channels (Website, Facebook, Instagram, LinkedIn, Referral, Direct, Other)

2. **Social Media Integration**

   - Integrate Facebook Business API for lead capture and engagement tracking
   - Integrate Instagram Business API for story views, post interactions, and DM tracking
   - Integrate LinkedIn Sales Navigator API for connection requests and message tracking
   - Create unified social interaction feed showing all touchpoints across platforms

3. **Advanced Lead Scoring**

   - Implement dynamic lead heat indicators (COLD, WARM, HOT) with visual representations
   - Create scoring algorithm based on social follows, likes, website visits, info requests, price quotes, and site visits
   - Auto-update lead heat scores based on real-time social and website interactions

4. **Lead Touchpoint Management**

   - Create comprehensive interaction tracking system for all touchpoint types
   - Implement touchpoint timeline view showing chronological engagement history
   - Support manual touchpoint entry and automated capture from social platforms

5. **Enhanced Lead Dashboard**
   - Create lead heat visualization dashboard with filtering and sorting capabilities
   - Implement lead pipeline view showing progression through qualification stages
   - Add social engagement metrics and trending indicators

## Tasks / Subtasks

- [x] **Task 1: Lead Data Model Enhancement** (AC: 1)

  - [x] Extend Contact model with social profiles, custom fields, and interaction history
  - [x] Update Convex schema to support enhanced lead data structure
  - [x] Create TypeScript interfaces for social profiles and custom field types
  - [x] Implement database indexes for efficient lead querying and filtering

- [x] **Task 2: Social Media API Integrations** (AC: 2)

  - [x] Set up Facebook Business API integration for lead capture
  - [x] Implement Instagram Business API for engagement tracking
  - [x] Create LinkedIn Sales Navigator API integration
  - [x] Build unified social interaction service layer
  - [x] Create webhook handlers for real-time social media updates

- [ ] **Task 3: Dynamic Lead Heat Calculation System** (AC: 1, 3)

  - [ ] Implement lead heat scoring algorithm with configurable weights
  - [ ] Create Convex mutation for real-time heat score updates
  - [ ] Build automated heat recalculation triggers based on interactions
  - [ ] Add visual heat indicators (color coding, progress bars, badges)

- [ ] **Task 4: Interaction Tracking System** (AC: 4)

  - [ ] Create Interaction model with support for all touchpoint types
  - [ ] Implement interaction capture service for automated social media tracking
  - [ ] Build manual interaction entry forms for sales team usage
  - [ ] Create interaction timeline component with filtering capabilities

- [ ] **Task 5: Enhanced Lead Dashboard Interface** (AC: 5)

  - [ ] Build lead heat visualization dashboard with interactive charts
  - [ ] Create lead pipeline kanban view with drag-and-drop functionality
  - [ ] Implement advanced filtering and sorting by heat score, source, and status
  - [ ] Add social engagement metrics display and trending indicators

- [ ] **Task 6: API Integration Security & Rate Limiting** (AC: 2)
  - [ ] Implement secure API key management for social media platforms
  - [ ] Add rate limiting and error handling for external API calls
  - [ ] Create fallback mechanisms for API downtime scenarios
  - [ ] Implement data sync queues for reliable social media data processing

## Dev Notes

### Relevant Source Tree Information

- **Contact Management Components**: `src/components/features/contacts/` - Existing ContactList and contact forms to extend
- **tRPC API Routes**: `src/server/api/routers/contact.ts` - Extend with lead management procedures
- **Convex Database Schema**: `convex/schema.ts` - Update contacts table and add interactions table
- **Authentication**: Clerk integration already configured for protected routes
- **Social API Integration Location**: `src/server/api/services/` - Create new social media service layer

### Key Technical Context

- **T3 Stack Architecture**: Next.js 15 + tRPC + Convex + Clerk authentication
- **Database**: Convex real-time database with type-safe schema definitions
- **Frontend**: React with TypeScript, shadcn/ui components, Tailwind CSS
- **State Management**: tRPC with React Query for server state, Zustand for client state
- **Authentication**: Clerk handles OAuth with Google and GitHub, integrated with Convex

### Social Media API Requirements

- **Facebook Business API**: Requires Business Manager setup, app review for lead access permissions
- **Instagram Business API**: Connected through Facebook Business API, requires Instagram Business account
- **LinkedIn Sales Navigator API**: Requires LinkedIn Sales Navigator subscription and API partnership

### Lead Heat Calculation Algorithm

Based on interaction scoring system:

- Social Follow: 1 point
- Social Like: 1 point
- Website Visit: 2 points
- Info Request: 5 points
- Price Quote: 8 points
- Site Visit: 10 points
- Heat Levels: COLD (0-5), WARM (6-15), HOT (16+)

### Data Models to Extend

```typescript
// Extend existing Contact interface
interface Contact {
  // ... existing fields
  leadHeat: number;
  socialProfiles: SocialProfile[];
  customFields: Record<string, any>;
  interactions: Interaction[];
}

// New interaction tracking
interface Interaction {
  id: string;
  contactId: string;
  type: InteractionType;
  platform: SocialPlatform;
  metadata: Record<string, any>;
  createdAt: Date;
}
```

### Testing

**Test File Locations**:

- Frontend: `tests/components/contacts/` and `tests/pages/contacts/`
- Backend: `tests/api/contact.test.ts` and `tests/services/`
- E2E: `e2e/contacts.spec.ts`

**Testing Frameworks**:

- Frontend Unit Tests: Vitest + React Testing Library
- Backend Tests: Vitest with tRPC procedure testing
- E2E Tests: Playwright
- Social API Integration Tests: Mock external APIs using MSW

**Testing Requirements**:

- Test lead heat calculation algorithm with various interaction scenarios
- Test social media API integration error handling and rate limiting
- Test real-time lead heat updates in the dashboard
- Test lead pipeline drag-and-drop functionality
- Test social interaction timeline rendering and filtering

## Change Log

| Date       | Version | Description                                       | Author             |
| ---------- | ------- | ------------------------------------------------- | ------------------ |
| 2025-08-03 | 1.0     | Initial story creation for Epic 2 Lead Management | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

No debug issues encountered during Task 1 implementation.

### Completion Notes List

**Task 1 Completed:**
- Extended Contact interface with leadHeatScore, socialProfiles, customFields, lastInteractionAt
- Added new TypeScript types: SocialPlatform, InteractionType, SocialProfile, Interaction
- Updated Convex schema with enhanced contacts table and new interactions table
- Added comprehensive database indexes for efficient querying
- Created leadHeatCalculator utility with scoring algorithm
- Implemented interaction tracking API in convex/interactions.ts
- Updated existing contact mutations to support new fields
- All tests passing

**Task 2 Completed:**
- Built comprehensive social media service architecture with platform-specific APIs
- Implemented Facebook Business API service for lead form capture and page interactions
- Created Instagram Business API service for media insights and engagement tracking
- Developed LinkedIn Sales Navigator API service for lead generation and member engagement
- Built unified SocialMediaManager for coordinating all platform services
- Created SocialMediaIntegrationService for lead processing and interaction synchronization
- Implemented comprehensive webhook handlers for real-time Facebook, Instagram, and LinkedIn updates
- Built WebhookRouter with signature verification and platform-specific processing
- Created tRPC API endpoints for social media configuration, testing, and analytics
- Added API routes for webhook endpoints (/api/webhooks/facebook, /instagram, /linkedin)
- Implemented rate limiting, error handling, and fallback mechanisms
- Added comprehensive lead capture data processing with contact creation/updating

### File List

**Created:**
- `src/lib/utils/leadHeatCalculator.ts` - Lead heat scoring utilities
- `convex/interactions.ts` - Interaction tracking API
- `src/server/api/services/socialMediaService.ts` - Core social media API services
- `src/server/api/services/socialMediaIntegrationService.ts` - Unified integration service layer
- `src/server/api/services/webhookHandlers.ts` - Real-time webhook processing
- `src/server/api/routers/socialMedia.ts` - Full tRPC social media router
- `src/server/api/routers/socialMediaSimple.ts` - Simplified tRPC router for testing
- `src/app/api/webhooks/facebook/route.ts` - Facebook webhook endpoint
- `src/app/api/webhooks/instagram/route.ts` - Instagram webhook endpoint
- `src/app/api/webhooks/linkedin/route.ts` - LinkedIn webhook endpoint
- `tests/utils/leadHeatCalculator.test.ts` - Lead heat calculator tests
- `tests/api/contacts-enhanced.test.ts` - Enhanced contacts API tests  
- `tests/api/interactions.test.ts` - Interactions API tests
- `tests/api/socialMedia.test.ts` - Social media service tests
- `tests/api/webhooks.test.ts` - Webhook handler tests

**Modified:**
- `src/lib/types/contact.ts` - Extended with new types and interfaces
- `convex/schema.ts` - Added enhanced contact fields and interactions table
- `convex/contacts.ts` - Updated create/update mutations for new fields
- `src/server/api/root.ts` - Added social media router to tRPC app router

## QA Results

_This section will be populated by the QA Agent after story completion_
