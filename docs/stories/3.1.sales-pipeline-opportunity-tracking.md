# Story 3.1: Sales Pipeline & Opportunity Tracking

## Status

On-Hold

## Story

**As a** sales team member,
**I want** a fully customizable CRM sales pipeline with detailed opportunity card information, advanced date conflict management, and basic LLM-powered sales suggestions,
**so that** I can efficiently track sales progression from initial prospect through to closed deal with clear visibility of all opportunities and their current status.

## Acceptance Criteria

1. **Customizable Sales Pipeline Stages**

   - Implement drag-and-drop Kanban-style pipeline with configurable stages
   - Support custom stage names and pipeline workflow customization
   - Provide stage progression validation and required field enforcement
   - Enable bulk opportunity management and stage transitions

2. **Detailed Opportunity Management**

   - Create comprehensive opportunity cards with event details (type, date, guest count, venue requirements)
   - Implement opportunity value tracking and revenue forecasting
   - Support opportunity-to-project conversion workflow
   - Enable opportunity assignment and collaboration features

3. **Advanced Date Conflict Detection**

   - Implement intelligent date conflict detection for venue bookings
   - Provide automatic conflict alerts and resolution suggestions
   - Support date range blocking and availability management
   - Enable calendar integration for comprehensive scheduling

4. **Basic LLM-Powered Sales Suggestions**
   - Implement AI-powered opportunity scoring and prioritization
   - Provide intelligent follow-up recommendations based on opportunity stage
   - Generate automated sales task suggestions and reminders
   - Enable AI-assisted opportunity categorization and tagging

## Tasks / Subtasks

- [x] **Task 1: Opportunity Data Model and API Layer** (AC: 1, 2)

  - [x] Extend Convex schema with comprehensive Opportunity model including event details, value tracking, and venue requirements
  - [x] Create Convex opportunity functions with CRUD operations, stage management, and validation
  - [x] Implement opportunity-contact relationship management and assignment functionality
  - [x] Add database indexes for efficient pipeline querying and filtering

  - [x] Create opportunity value calculation and revenue forecasting utilities

- [ ] **Task 2: Kanban Pipeline Interface** (AC: 1)

  - [x] Build drag-and-drop Kanban board component using @dnd-kit library for stage management
  - [x] Create opportunity card component with comprehensive details display and quick actions
  - [x] Implement pipeline stage configuration interface for custom workflow setup
  - [x] Add bulk opportunity operations (mass stage transitions, assignments, deletions)
  - [x] Create pipeline filtering and search functionality with real-time updates

- [x] **Task 3: Date Conflict Management System** (AC: 3)

  - [x] Implement venue availability tracking and calendar integration
  - [x] Create date conflict detection algorithm for double-booking prevention
  - [x] Build conflict resolution interface with alternative date suggestions
  - [x] Add calendar view component for visual scheduling and availability management
  - [x] Implement booking confirmation workflow with client notifications

- [ ] **Task 4: AI-Powered Sales Intelligence** (AC: 4) - ON HOLD

  - [ ] Integrate basic LLM functionality for opportunity analysis and scoring
  - [ ] Create intelligent follow-up recommendation engine based on opportunity patterns
  - [ ] Implement automated task generation for sales team productivity
  - [ ] Build AI-assisted opportunity categorization and lead qualification
  - [ ] Add sales performance analytics with AI-powered insights

- [x] **Task 5: Pipeline Analytics and Reporting** (AC: 1, 2)
  - [x] Create sales pipeline metrics dashboard with conversion rate tracking
  - [x] Implement revenue forecasting and pipeline value calculations
  - [x] Build sales performance reports with team and individual metrics
  - [x] Add pipeline health indicators and bottleneck identification
  - [x] Create exportable reports for sales management and leadership

## Dev Notes

### Relevant Source Tree Information

**Current Project Structure Alignment:**

- Opportunity pages should be created at `src/app/(dashboard)/opportunities/page.tsx` [Source: architecture/unified-project-structure.md#route-organization]
- CRM Pipeline components belong in `src/components/features/opportunities/` [Source: architecture/unified-project-structure.md#component-organization]
- tRPC opportunity router should be implemented at `src/server/api/routers/opportunity.ts` [Source: architecture/backend-architecture.md#trpc-router-organization]

**Previous Story Context:**
From Story 2.1 QA Review: Missing service layer implementations identified - ensure opportunity service layer is complete with proper error handling and validation. Drag-and-drop functionality was successfully implemented in LeadPipeline but needed animation polish - apply learnings for smooth opportunity pipeline interactions. [Source: Story 2.1 QA Results]

### Data Models

**Opportunity Model from Architecture:**

```typescript
interface Opportunity {
  id: string;
  name: string;
  contactId: string;
  stage: string;
  value: number;
  eventType: string;
  eventDate: Date;
  guestCount: number;
  requiresCatering: boolean;
  roomAssignment?: string;
  customFields: Record<string, any>;
  createdAt: Date;
  updatedAt: Date;

  // Relations
  contact: Contact;
  project?: Project;
  documents: Document[];
  payments: Payment[];
}
```

[Source: architecture/data-models.md#opportunity-model]

**Database Schema Requirements:**

- Use Convex `defineTable` with proper validation for all opportunity fields
- Implement indexes for efficient querying: `by_contact`, `by_stage`, `by_event_date`
- Follow established contact relationship patterns from existing schema
  [Source: architecture/backend-architecture.md#convex-integration]

### API Specifications

**tRPC Router Structure:**

- Follow established pattern from contact router with proper input validation using Zod schemas
- Implement protected procedures with role-based access control (ADMIN, SALES roles)
- Use proper error handling with TRPCError codes (UNAUTHORIZED, FORBIDDEN, BAD_REQUEST)
- Include real-time updates via Convex subscriptions for collaborative pipeline management
  [Source: architecture/backend-architecture.md#server-side-function-template]

**Required Procedures:**

- `opportunity.create` - Create new opportunity with contact linking
- `opportunity.getAll` - Fetch opportunities with filtering and pagination
- `opportunity.updateStage` - Handle stage transitions with validation
- `opportunity.delete` - Soft delete with audit trail
- `opportunity.getByContact` - Fetch opportunities for specific contact
  [Source: architecture/api-specification.md#trpc-router-structure]

### Component Specifications

**CRM Pipeline Module Architecture:**

- Implement drag-and-drop Kanban board using @dnd-kit library for stage management
- Create opportunity detail modals with comprehensive event information display
- Build stage progression validation with required field enforcement
- Add date conflict detection interface with visual calendar integration
  [Source: architecture/components.md#crm-pipeline-module]

**Component Organization:**

```
src/components/features/opportunities/
├── OpportunityPipeline.tsx     # Main Kanban pipeline component
├── OpportunityCard.tsx         # Individual opportunity display card
├── OpportunityDetail.tsx       # Detailed opportunity modal/page
├── OpportunityForm.tsx         # Create/edit opportunity form
├── StageColumn.tsx            # Pipeline stage column component
├── DateConflictAlert.tsx      # Conflict detection and resolution
└── OpportunityAnalytics.tsx   # Pipeline metrics and reporting
```

[Source: architecture/frontend-architecture.md#component-organization]

### File Locations

**Next.js App Router Pages:**

- Main pipeline page: `src/app/(dashboard)/opportunities/page.tsx`
- Individual opportunity detail: `src/app/(dashboard)/opportunities/[id]/page.tsx`
- Follow protected route pattern with Clerk authentication middleware
  [Source: architecture/frontend-architecture.md#route-organization-nextjs-15-app-router]

**State Management:**

- Use tRPC with React Query for server state management (opportunities data)
- Implement Zustand for UI state (sidebar, modals, filters)
- Follow established patterns from contact management implementation
  [Source: architecture/frontend-architecture.md#state-management-patterns]

### Technical Constraints

**Authentication and Authorization:**

- All opportunity operations require authenticated users with SALES or ADMIN roles
- Implement proper authorization middleware in tRPC procedures
- Use Clerk user context for user identification and role checking
  [Source: architecture/backend-architecture.md#authentication-and-authorization]

**Performance Considerations:**

- Implement proper database indexing for opportunity queries
- Use React Query caching for pipeline data to minimize API calls
- Implement optimistic updates for drag-and-drop operations
- Follow real-time update patterns established in contact management
  [Source: architecture/security-and-performance.md#performance-optimization]

**Technology Stack Compliance:**

- Next.js 14.x with TypeScript for type safety
- Convex for real-time database operations
- shadcn/ui components for consistent design system
- @dnd-kit for drag-and-drop functionality (proven in LeadPipeline)
  [Source: architecture/tech-stack.md#technology-stack-table]

### Testing

**Test File Locations:**

- Frontend component tests: `tests/components/opportunities/`
- tRPC procedure tests: `tests/api/opportunity.test.ts`
- E2E pipeline tests: `e2e/crm.spec.ts`
  [Source: architecture/testing-strategy.md#test-organization]

**Testing Requirements:**

- Unit tests for all opportunity components with React Testing Library
- Integration tests for tRPC opportunity procedures with mock database
- E2E tests for complete pipeline workflow including drag-and-drop operations
- Test date conflict detection algorithm with various scheduling scenarios
  [Source: architecture/testing-strategy.md#test-examples]

**Testing Frameworks:**

- Vitest for unit and integration tests
- Playwright for E2E testing
- MSW for API mocking in tests
- Follow established patterns from contact management tests
  [Source: architecture/tech-stack.md#testing-framework]

## Change Log

| Date       | Version | Description                                                            | Author             |
| ---------- | ------- | ---------------------------------------------------------------------- | ------------------ |
| 2025-08-04 | 1.0     | Initial story creation for Epic 3 Sales Pipeline                       | Bob (Scrum Master) |
| 2025-08-09 | 2.0     | Task 3 implementation completed - Date Conflict Management System      | Claude (Dev Agent) |
| 2025-08-09 | 2.1     | Fixed opportunity form validation (guestCount and value as numbers)    | Claude (Dev Agent) |
| 2025-08-09 | 2.2     | Fixed drag-and-drop validation (prevent dropping on opportunity cards) | Claude (Dev Agent) |
| 2025-08-09 | 2.3     | Enhanced opportunity cards with visual date conflict indicators        | Claude (Dev Agent) |
| 2025-08-09 | 3.0     | Task 5 implementation completed - Pipeline Analytics and Reporting     | Claude (Dev Agent) |
| 2025-08-09 | 3.1     | Added tabbed interface to opportunities page for all analytics views   | Claude (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Implementation Summary

**Tasks Completed:**

- ✅ Task 1: Opportunity Data Model and API Layer (Previously completed)
- ✅ Task 2: Kanban Pipeline Interface (Previously completed)
- ✅ Task 3: Date Conflict Management System (Implemented 2025-08-09)
- ❌ Task 4: AI-Powered Sales Intelligence (ON HOLD per user request)
- ✅ Task 5: Pipeline Analytics and Reporting (Implemented 2025-08-09)

### Task 3 Completion Notes

**Date Conflict Management System Implementation:**

1. **Database Schema Extensions** - Added venues, venueAvailability, and conflictDetectionLog tables to Convex schema
2. **Backend Services** - Created comprehensive venue management functions in `convex/venues.ts`
3. **Conflict Detection Algorithm** - Enhanced opportunity functions with intelligent conflict detection
4. **Frontend Components** - Built DateConflictAlert.tsx with resolution interface
5. **Calendar Integration** - Developed VenueCalendar.tsx with week/month views and drag-and-drop
6. **Booking Workflow** - Created BookingConfirmation.tsx with multi-step confirmation process
7. **Visual Indicators** - Enhanced OpportunityCard.tsx with date conflict warnings

**Bug Fixes During Implementation:**

- Fixed React Hook Form number validation by adding `valueAsNumber: true`
- Prevented drag-and-drop errors by validating drop targets in KanbanBoard
- Added visual date conflict indicators with orange styling and warning icons

### Task 5 Completion Notes

**Pipeline Analytics and Reporting Implementation:**

1. **Analytics Dashboard** - Created PipelineAnalytics.tsx with comprehensive metrics
2. **Revenue Forecasting** - Enhanced backend with advanced analytics functions
3. **Performance Reporting** - Built SalesPerformanceReport.tsx with team leaderboards
4. **Health Indicators** - Developed PipelineHealthIndicators.tsx with bottleneck detection
5. **Export Functionality** - Created reportExport.ts utility for CSV/JSON exports
6. **Navigation Integration** - Added tabbed interface to opportunities page

**Key Metrics Implemented:**

- Pipeline value tracking, win rates, conversion rates, sales velocity
- Team performance rankings, individual metrics, health scoring
- Bottleneck identification, stale opportunity detection, concentration risk analysis
- Executive reporting with exportable formats

### Debug Log References

- **Date Conflict Issue**: Resolved drag-and-drop validation error by checking valid stage IDs
- **Form Validation**: Fixed ArgumentValidationError for guestCount by ensuring number conversion
- **Visual Indicators**: Implemented real-time conflict detection across all pipeline stages

### File List

**Backend Files:**

- `convex/schema.ts` - Extended with venue and conflict management tables
- `convex/venues.ts` - Venue management and availability tracking
- `convex/opportunities.ts` - Enhanced with analytics and conflict detection

**Frontend Components:**

- `src/components/features/opportunities/DateConflictAlert.tsx` - Conflict visualization and resolution
- `src/components/features/opportunities/VenueCalendar.tsx` - Calendar view with booking management
- `src/components/features/opportunities/BookingConfirmation.tsx` - Multi-step booking workflow
- `src/components/features/opportunities/PipelineAnalytics.tsx` - Comprehensive metrics dashboard
- `src/components/features/opportunities/SalesPerformanceReport.tsx` - Team performance reporting
- `src/components/features/opportunities/PipelineHealthIndicators.tsx` - Health monitoring and bottlenecks
- `src/components/features/opportunities/OpportunityCard.tsx` - Enhanced with conflict indicators

**Utilities and Types:**

- `src/lib/types/venue.ts` - Venue and conflict management types
- `src/lib/utils/reportExport.ts` - Export functionality for reports
- `src/components/ui/progress.tsx` - Progress bar component
- `src/components/ui/avatar.tsx` - Enhanced avatar with initials

**Pages:**

- `src/app/opportunities/page.tsx` - Updated with tabbed navigation for all analytics views

## QA Results

_QA review will be added here after story completion_
