# Story 3.1: Sales Pipeline & Opportunity Tracking

## Status

Approved

## Story

**As a** sales team member,
**I want** a fully customizable CRM sales pipeline with detailed opportunity card information, advanced date conflict management, and basic LLM-powered sales suggestions,
**so that** I can efficiently track sales progression from initial prospect through to closed deal with clear visibility of all opportunities and their current status.

## Acceptance Criteria

1. **Customizable Sales Pipeline Stages**

   - Implement drag-and-drop Kanban-style pipeline with configurable stages
   - Support custom stage names and pipeline workflow customization
   - Provide stage progression validation and required field enforcement
   - Enable bulk opportunity management and stage transitions

2. **Detailed Opportunity Management**

   - Create comprehensive opportunity cards with event details (type, date, guest count, venue requirements)
   - Implement opportunity value tracking and revenue forecasting
   - Support opportunity-to-project conversion workflow
   - Enable opportunity assignment and collaboration features

3. **Advanced Date Conflict Detection**

   - Implement intelligent date conflict detection for venue bookings
   - Provide automatic conflict alerts and resolution suggestions
   - Support date range blocking and availability management
   - Enable calendar integration for comprehensive scheduling

4. **Basic LLM-Powered Sales Suggestions**
   - Implement AI-powered opportunity scoring and prioritization
   - Provide intelligent follow-up recommendations based on opportunity stage
   - Generate automated sales task suggestions and reminders
   - Enable AI-assisted opportunity categorization and tagging

## Tasks / Subtasks

- [x] **Task 1: Opportunity Data Model and API Layer** (AC: 1, 2)

  - [x] Extend Convex schema with comprehensive Opportunity model including event details, value tracking, and venue requirements
  - [x] Create Convex opportunity functions with CRUD operations, stage management, and validation
  - [x] Implement opportunity-contact relationship management and assignment functionality
  - [x] Add database indexes for efficient pipeline querying and filtering

  - [x] Create opportunity value calculation and revenue forecasting utilities

- [ ] **Task 2: Kanban Pipeline Interface** (AC: 1)

  - [x] Build drag-and-drop Kanban board component using @dnd-kit library for stage management
  - [x] Create opportunity card component with comprehensive details display and quick actions
  - [x] Implement pipeline stage configuration interface for custom workflow setup
  - [x] Add bulk opportunity operations (mass stage transitions, assignments, deletions)
  - [x] Create pipeline filtering and search functionality with real-time updates

- [x] **Task 3: Date Conflict Management System** (AC: 3)

  - [x] Implement venue availability tracking and calendar integration
  - [x] Create date conflict detection algorithm for double-booking prevention
  - [x] Build conflict resolution interface with alternative date suggestions
  - [x] Add calendar view component for visual scheduling and availability management
  - [x] Implement booking confirmation workflow with client notifications

- [ ] **Task 4: AI-Powered Sales Intelligence** (AC: 4) - ON HOLD

  - [ ] Integrate basic LLM functionality for opportunity analysis and scoring
  - [ ] Create intelligent follow-up recommendation engine based on opportunity patterns
  - [ ] Implement automated task generation for sales team productivity
  - [ ] Build AI-assisted opportunity categorization and lead qualification
  - [ ] Add sales performance analytics with AI-powered insights

- [ ] **Task 5: Pipeline Analytics and Reporting** (AC: 1, 2)
  - [ ] Create sales pipeline metrics dashboard with conversion rate tracking
  - [ ] Implement revenue forecasting and pipeline value calculations
  - [ ] Build sales performance reports with team and individual metrics
  - [ ] Add pipeline health indicators and bottleneck identification
  - [ ] Create exportable reports for sales management and leadership

## Dev Notes

### Relevant Source Tree Information

**Current Project Structure Alignment:**

- Opportunity pages should be created at `src/app/(dashboard)/opportunities/page.tsx` [Source: architecture/unified-project-structure.md#route-organization]
- CRM Pipeline components belong in `src/components/features/opportunities/` [Source: architecture/unified-project-structure.md#component-organization]
- tRPC opportunity router should be implemented at `src/server/api/routers/opportunity.ts` [Source: architecture/backend-architecture.md#trpc-router-organization]

**Previous Story Context:**
From Story 2.1 QA Review: Missing service layer implementations identified - ensure opportunity service layer is complete with proper error handling and validation. Drag-and-drop functionality was successfully implemented in LeadPipeline but needed animation polish - apply learnings for smooth opportunity pipeline interactions. [Source: Story 2.1 QA Results]

### Data Models

**Opportunity Model from Architecture:**

```typescript
interface Opportunity {
  id: string;
  name: string;
  contactId: string;
  stage: string;
  value: number;
  eventType: string;
  eventDate: Date;
  guestCount: number;
  requiresCatering: boolean;
  roomAssignment?: string;
  customFields: Record<string, any>;
  createdAt: Date;
  updatedAt: Date;

  // Relations
  contact: Contact;
  project?: Project;
  documents: Document[];
  payments: Payment[];
}
```

[Source: architecture/data-models.md#opportunity-model]

**Database Schema Requirements:**

- Use Convex `defineTable` with proper validation for all opportunity fields
- Implement indexes for efficient querying: `by_contact`, `by_stage`, `by_event_date`
- Follow established contact relationship patterns from existing schema
  [Source: architecture/backend-architecture.md#convex-integration]

### API Specifications

**tRPC Router Structure:**

- Follow established pattern from contact router with proper input validation using Zod schemas
- Implement protected procedures with role-based access control (ADMIN, SALES roles)
- Use proper error handling with TRPCError codes (UNAUTHORIZED, FORBIDDEN, BAD_REQUEST)
- Include real-time updates via Convex subscriptions for collaborative pipeline management
  [Source: architecture/backend-architecture.md#server-side-function-template]

**Required Procedures:**

- `opportunity.create` - Create new opportunity with contact linking
- `opportunity.getAll` - Fetch opportunities with filtering and pagination
- `opportunity.updateStage` - Handle stage transitions with validation
- `opportunity.delete` - Soft delete with audit trail
- `opportunity.getByContact` - Fetch opportunities for specific contact
  [Source: architecture/api-specification.md#trpc-router-structure]

### Component Specifications

**CRM Pipeline Module Architecture:**

- Implement drag-and-drop Kanban board using @dnd-kit library for stage management
- Create opportunity detail modals with comprehensive event information display
- Build stage progression validation with required field enforcement
- Add date conflict detection interface with visual calendar integration
  [Source: architecture/components.md#crm-pipeline-module]

**Component Organization:**

```
src/components/features/opportunities/
├── OpportunityPipeline.tsx     # Main Kanban pipeline component
├── OpportunityCard.tsx         # Individual opportunity display card
├── OpportunityDetail.tsx       # Detailed opportunity modal/page
├── OpportunityForm.tsx         # Create/edit opportunity form
├── StageColumn.tsx            # Pipeline stage column component
├── DateConflictAlert.tsx      # Conflict detection and resolution
└── OpportunityAnalytics.tsx   # Pipeline metrics and reporting
```

[Source: architecture/frontend-architecture.md#component-organization]

### File Locations

**Next.js App Router Pages:**

- Main pipeline page: `src/app/(dashboard)/opportunities/page.tsx`
- Individual opportunity detail: `src/app/(dashboard)/opportunities/[id]/page.tsx`
- Follow protected route pattern with Clerk authentication middleware
  [Source: architecture/frontend-architecture.md#route-organization-nextjs-15-app-router]

**State Management:**

- Use tRPC with React Query for server state management (opportunities data)
- Implement Zustand for UI state (sidebar, modals, filters)
- Follow established patterns from contact management implementation
  [Source: architecture/frontend-architecture.md#state-management-patterns]

### Technical Constraints

**Authentication and Authorization:**

- All opportunity operations require authenticated users with SALES or ADMIN roles
- Implement proper authorization middleware in tRPC procedures
- Use Clerk user context for user identification and role checking
  [Source: architecture/backend-architecture.md#authentication-and-authorization]

**Performance Considerations:**

- Implement proper database indexing for opportunity queries
- Use React Query caching for pipeline data to minimize API calls
- Implement optimistic updates for drag-and-drop operations
- Follow real-time update patterns established in contact management
  [Source: architecture/security-and-performance.md#performance-optimization]

**Technology Stack Compliance:**

- Next.js 14.x with TypeScript for type safety
- Convex for real-time database operations
- shadcn/ui components for consistent design system
- @dnd-kit for drag-and-drop functionality (proven in LeadPipeline)
  [Source: architecture/tech-stack.md#technology-stack-table]

### Testing

**Test File Locations:**

- Frontend component tests: `tests/components/opportunities/`
- tRPC procedure tests: `tests/api/opportunity.test.ts`
- E2E pipeline tests: `e2e/crm.spec.ts`
  [Source: architecture/testing-strategy.md#test-organization]

**Testing Requirements:**

- Unit tests for all opportunity components with React Testing Library
- Integration tests for tRPC opportunity procedures with mock database
- E2E tests for complete pipeline workflow including drag-and-drop operations
- Test date conflict detection algorithm with various scheduling scenarios
  [Source: architecture/testing-strategy.md#test-examples]

**Testing Frameworks:**

- Vitest for unit and integration tests
- Playwright for E2E testing
- MSW for API mocking in tests
- Follow established patterns from contact management tests
  [Source: architecture/tech-stack.md#testing-framework]

## Change Log

| Date       | Version | Description                                      | Author             |
| ---------- | ------- | ------------------------------------------------ | ------------------ |
| 2025-08-04 | 1.0     | Initial story creation for Epic 3 Sales Pipeline | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

### Completion Notes List

### File List

## QA Results

_QA review will be added here after story completion_
