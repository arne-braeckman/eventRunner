# Story 4.1: Proposal Generation & Tracking

## Status

Approved

## Story

**As a** sales team member,
**I want** to generate professional event proposals from opportunity data and track their status with client interactions,
**so that** I can efficiently convert qualified opportunities into signed contracts with clear visibility of proposal progress.

## Acceptance Criteria

1. **Proposal Generation System**

   - Generate professional proposals from opportunity data with customizable templates
   - Include event details, pricing, venue information, and terms
   - Support PDF export and email delivery to clients
   - Enable branding customization and company information

2. **Proposal Status Tracking**

   - Track proposal lifecycle: Draft, Sent, Viewed, Under Review, Accepted, Rejected
   - Real-time status updates and client interaction logging
   - Follow-up reminder system based on proposal age and status
   - Integration with opportunity pipeline for automatic stage progression

3. **Document Template Management**

   - Create and manage proposal templates with dynamic fields
   - Support different templates for event types (wedding, corporate, etc.)
   - Version control for templates and generated proposals
   - Template preview and editing capabilities

4. **Client Interaction Features**
   - Client-facing proposal portal for review and acceptance
   - Comment system for client feedback and negotiation
   - Document sharing and version tracking
   - Digital signature readiness (foundation for Epic 5)

## Tasks / Subtasks

- [x] **Task 1: Proposal Data Model and API Layer** (AC: 1, 2)

  - [x] Extend Convex schema with proposals, proposalTemplates, and proposalInteractions tables
  - [x] Create Convex proposal functions with CRUD operations, status management, and validation
  - [x] Implement proposal-opportunity relationship management and status synchronization
  - [x] Add database indexes for efficient proposal querying and filtering

- [x] **Task 2: Document Template System** (AC: 3)

  - [x] Build template management interface with rich text editor
  - [x] Create dynamic field system for opportunity data injection
  - [x] Implement template versioning and revision control
  - [x] Add template preview functionality with sample data
  - [x] Support event-type specific template organization

- [ ] **Task 3: Proposal Generation Engine** (AC: 1)

  - [ ] Create proposal generator with template merging and PDF export
  - [ ] Implement dynamic content injection from opportunity data
  - [ ] Build email delivery system with Resend integration
  - [ ] Add branding customization and company information integration
  - [ ] Create proposal preview and approval workflow

- [ ] **Task 4: Status Tracking and Workflow** (AC: 2)

  - [ ] Implement proposal lifecycle state management
  - [ ] Create client interaction tracking and logging system
  - [ ] Build automated follow-up reminder system
  - [ ] Add real-time status updates with Convex subscriptions
  - [ ] Integrate proposal status with opportunity pipeline progression

- [ ] **Task 5: Client Portal Interface** (AC: 4)
  - [ ] Build client-facing proposal review interface
  - [ ] Create comment and feedback system for client collaboration
  - [ ] Implement secure document sharing with access controls
  - [ ] Add proposal acceptance/rejection workflow
  - [ ] Create foundation for digital signature integration (Epic 5 prep)

## Dev Notes

### Relevant Source Tree Information

**Current Project Structure Alignment:**

- Proposal pages should be created at `src/app/(dashboard)/proposals/page.tsx` [Source: architecture/unified-project-structure.md#route-organization]
- Proposal components belong in `src/components/features/proposals/` [Source: architecture/unified-project-structure.md#component-organization]
- tRPC proposal router should be implemented at `src/server/api/routers/proposal.ts` [Source: architecture/backend-architecture.md#trpc-router-organization]

**Previous Story Context:**
From Story 3.1 Implementation: Successfully implemented Convex schema extensions and real-time analytics with proper form validation patterns. Key learnings: Use `valueAsNumber: true` for React Hook Form number inputs, implement proper drag-and-drop validation, and leverage Convex real-time subscriptions for collaborative features. Export functionality patterns established with `reportExport.ts` utility can be adapted for proposal PDF generation. [Source: Story 3.1 Dev Agent Record]

### Data Models

**Proposal Model from Architecture Requirements:**

Based on Epic 4 requirements for FR14 (Proposal Tracking & Visibility) and FR4 (Document & Contract Management), the Proposal model should include:

```typescript
interface Proposal {
  id: string;
  opportunityId: string;
  templateId: string;
  title: string;
  status: ProposalStatus;
  version: number;
  content: object; // Rich content structure
  clientAccessToken: string; // For secure client portal access
  sentAt?: Date;
  viewedAt?: Date;
  respondedAt?: Date;
  expiresAt?: Date;
  createdAt: Date;
  updatedAt: Date;

  // Relations
  opportunity: Opportunity;
  template: ProposalTemplate;
  interactions: ProposalInteraction[];
  comments: ProposalComment[];
}

enum ProposalStatus {
  DRAFT = "draft",
  SENT = "sent",
  VIEWED = "viewed",
  UNDER_REVIEW = "under_review",
  ACCEPTED = "accepted",
  REJECTED = "rejected",
  EXPIRED = "expired",
}
```

[Source: architecture/data-models.md#core-business-entities]

**Document Template Model:**

```typescript
interface ProposalTemplate {
  id: string;
  name: string;
  eventTypes: string[]; // WEDDING, CORPORATE, etc.
  content: object; // Rich template structure with dynamic fields
  version: number;
  isActive: boolean;
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
}
```

**Database Schema Requirements:**

- Use Convex `defineTable` with proper validation for all proposal fields
- Implement indexes for efficient querying: `by_opportunity`, `by_status`, `by_client_token`
- Follow established relationship patterns from existing schema
  [Source: architecture/backend-architecture.md#convex-integration]

### API Specifications

**tRPC Router Structure:**

- Follow established pattern from opportunity router with proper input validation using Zod schemas
- Implement protected procedures with role-based access control (ADMIN, SALES roles)
- Use proper error handling with TRPCError codes (UNAUTHORIZED, FORBIDDEN, BAD_REQUEST)
- Include real-time updates via Convex subscriptions for collaborative proposal management
  [Source: architecture/backend-architecture.md#server-side-function-template]

**Required Procedures:**

- `proposal.create` - Create new proposal from opportunity
- `proposal.getAll` - Fetch proposals with filtering and pagination
- `proposal.getById` - Get single proposal with full details
- `proposal.updateStatus` - Handle status transitions with validation
- `proposal.generatePdf` - Export proposal to PDF format
- `proposal.sendToClient` - Email proposal to client with portal access
- `proposal.getByClientToken` - Public endpoint for client portal access
  [Source: architecture/api-specification.md#trpc-router-structure]

### Component Specifications

**Document Management Module Architecture:**

- Implement rich text editor for template creation using shadcn/ui components
- Create proposal preview interface with PDF.js integration
- Build status tracking interface with real-time updates
- Add secure client portal with token-based authentication
  [Source: architecture/components.md#document-management-system]

**Component Organization:**

```
src/components/features/proposals/
├── ProposalPipeline.tsx         # Main proposal management interface
├── ProposalCard.tsx             # Individual proposal display card
├── ProposalForm.tsx             # Create/edit proposal form
├── ProposalPreview.tsx          # PDF preview component
├── ProposalStatusTracker.tsx    # Status progression indicator
├── TemplateEditor.tsx           # Rich text template editor
├── TemplateLibrary.tsx          # Template management interface
├── ClientPortal.tsx             # Client-facing proposal view
└── ProposalComments.tsx         # Comment and feedback system
```

[Source: architecture/frontend-architecture.md#component-organization]

### File Locations

**Next.js App Router Pages:**

- Main proposals page: `src/app/(dashboard)/proposals/page.tsx`
- Individual proposal detail: `src/app/(dashboard)/proposals/[id]/page.tsx`
- Client portal (public): `src/app/portal/[token]/page.tsx`
- Follow protected route pattern with Clerk authentication middleware
  [Source: architecture/frontend-architecture.md#route-organization-nextjs-15-app-router]

**State Management:**

- Use tRPC with React Query for server state management (proposal data)
- Implement Zustand for UI state (editor, preview modals, client portal)
- Follow established patterns from opportunity management implementation
  [Source: architecture/frontend-architecture.md#state-management-patterns]

### Technical Constraints

**Authentication and Authorization:**

- All proposal operations require authenticated users with SALES or ADMIN roles
- Client portal access uses secure token-based authentication (no login required)
- Implement proper authorization middleware in tRPC procedures
- Use Clerk user context for user identification and role checking
  [Source: architecture/backend-architecture.md#authentication-and-authorization]

**Performance Considerations:**

- Implement proper database indexing for proposal queries
- Use React Query caching for proposal data to minimize API calls
- Implement optimistic updates for status changes
- Follow real-time update patterns established in opportunity management
  [Source: architecture/security-and-performance.md#performance-optimization]

**Technology Stack Compliance:**

- Next.js 14.x with TypeScript for type safety
- Convex for real-time database operations
- shadcn/ui components for consistent design system
- PDF.js for document preview functionality
- Resend for email delivery service
  [Source: architecture/tech-stack.md#technology-stack-table]

## Testing

**Test File Locations:**

- Frontend component tests: `tests/components/proposals/`
- tRPC procedure tests: `tests/api/proposal.test.ts`
- E2E proposal workflow tests: `e2e/proposals.spec.ts`
  [Source: architecture/testing-strategy.md#test-organization]

**Testing Requirements:**

- Unit tests for all proposal components with React Testing Library
- Integration tests for tRPC proposal procedures with mock database
- E2E tests for complete proposal workflow including client portal access
- Test PDF generation and email delivery with mock services
- Test template editing and dynamic content injection
  [Source: architecture/testing-strategy.md#test-examples]

**Testing Frameworks:**

- Vitest for unit and integration tests
- Playwright for E2E testing
- MSW for API mocking in tests
- Follow established patterns from opportunity management tests
  [Source: architecture/tech-stack.md#testing-framework]

## Change Log

| Date       | Version | Description                                           | Author             |
| ---------- | ------- | ----------------------------------------------------- | ------------------ |
| 2025-08-09 | 1.0     | Initial story creation for Epic 4 Proposal Generation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

- TypeScript compilation validated for proposal functions
- Convex schema extended successfully with proper indexing
- Basic unit tests passing for type validation
- **Convex deployment successful**: All 22 new proposal-related indexes created successfully
- Fixed middleware.ts location issue (moved from convex/ to project root)

### Completion Notes

**Task 1: Proposal Data Model and API Layer - COMPLETED**

1. **Schema Extension**: Added 4 new tables to Convex schema:
   - `proposalTemplates`: Template management with event type support
   - `proposals`: Core proposal entity with status tracking and client access tokens
   - `proposalInteractions`: Audit trail for all proposal interactions
   - `proposalComments`: Comment system for client collaboration

2. **API Functions**: Created comprehensive Convex functions:
   - `convex/proposals.ts`: 8 functions for proposal CRUD, status management, client portal access
   - `convex/proposalTemplates.ts`: 7 functions for template management and versioning

3. **Key Features Implemented**:
   - Secure client access tokens for portal access
   - Automatic opportunity stage progression when proposal accepted
   - Interaction tracking for all proposal activities
   - Template versioning and event type filtering
   - Follow-up reminder system for proposals requiring attention

4. **Testing**: Created basic type validation tests in `tests/api/proposal.test.ts`

**Task 2: Document Template System - COMPLETED**

1. **Template Management Interface**: Built comprehensive `TemplateLibrary` component with:
   - Search functionality across template names
   - Event type filtering with dropdown
   - Template CRUD operations (create, edit, duplicate, archive)
   - Selection mode for proposal generation
   - Version display and management

2. **Rich Text Template Editor**: Created `TemplateEditor` component featuring:
   - Multi-tab interface for template configuration
   - Rich text editing with dynamic field injection
   - Template metadata management (name, event types)
   - Real-time preview with sample data
   - Template saving and validation

3. **Dynamic Field System**: Implemented comprehensive field injection:
   - Opportunity data fields (event details, pricing, contact info)
   - Dynamic content insertion with proper formatting
   - Event-type specific field suggestions
   - Template variable system for reusability

4. **Template Preview**: Built `TemplatePreview` component with:
   - Real-time preview with sample opportunity data
   - PDF export preparation (foundation for Task 3)
   - Template rendering with proper styling
   - Print-ready layout optimization

5. **UI Components**: Created missing shadcn/ui components:
   - `dialog.tsx` - Modal system for template editing and previews
   - `tabs.tsx` - Tabbed interface for template editor
   - `scroll-area.tsx` - Scrollable content areas

6. **Testing**: All TemplateLibrary tests passing with 7/7 test cases covering:
   - Template rendering and display
   - Search and filtering functionality
   - Selection mode behavior
   - Event type badge display
   - Version number display

### File List

**Backend Files:**
- `convex/schema.ts` - Extended with proposal-related tables and indexes
- `convex/proposals.ts` - Proposal management functions with CRUD operations
- `convex/proposalTemplates.ts` - Template management and versioning functions

**Frontend Components:**
- `src/components/features/proposals/TemplateLibrary.tsx` - Template management interface
- `src/components/features/proposals/TemplateEditor.tsx` - Rich text template editor
- `src/components/features/proposals/TemplatePreview.tsx` - Template preview with PDF export
- `src/components/ui/dialog.tsx` - Modal component for template editing
- `src/components/ui/tabs.tsx` - Tab interface for template editor
- `src/components/ui/scroll-area.tsx` - Scrollable content areas

**Test Files:**
- `tests/api/proposal.test.ts` - Type validation tests for proposal API
- `tests/components/proposals/TemplateLibrary.test.tsx` - Template library component tests

## QA Results

_QA review will be added here after story completion_
