# Story 1.2: Contact Management Dashboard

## Status

✅ **COMPLETED** - All tasks implemented and tested successfully

## Story

**As a** sales team member,
**I want** a comprehensive contact management dashboard with search, filtering, and detailed contact views,
**so that** I can efficiently manage and track all leads and contacts captured through the basic lead capture system.

## Acceptance Criteria

1. Contact list view displays all contacts with key information (name, email, leadSource, leadHeat, status)
2. Search functionality allows finding contacts by name or email
3. Filter functionality allows filtering by leadSource, leadHeat, and status
4. Contact detail view shows complete contact information and interaction history
5. Ability to edit contact information and update status
6. Pagination for large contact lists (show 20 contacts per page)
7. Real-time updates when contacts are added or modified
8. Export contacts to CSV functionality for sales team use

## Tasks / Subtasks

- [x] Task 1: Enhance Contact List Interface (AC: 1, 2, 3, 6, 7) ✅ COMPLETED

  - [x] Create enhanced ContactList component with table layout
  - [x] Implement search functionality with dropdown suggestions and URL state
  - [x] Add filter controls for leadSource, leadHeat, and status
  - [x] Implement pagination with navigation controls
  - [x] Integrate Convex real-time updates (automatic via useQuery)
  - [x] Style with responsive design for mobile and desktop

- [x] Task 2: Implement Contact Detail View (AC: 4) ✅ COMPLETED

  - [x] Create ContactDetail component with comprehensive information display
  - [x] Add contact interaction timeline/history section
  - [x] Implement breadcrumb navigation from list to detail
  - [x] Add proper loading states and error handling

- [x] Task 3: Add Contact Editing Capabilities (AC: 5) ✅ COMPLETED

  - [x] Create ContactEdit component with form validation
  - [x] Implement inline editing for contact status
  - [x] Add save/cancel functionality with optimistic updates
  - [x] Integrate with existing Convex mutations for updates

- [x] Task 4: Implement Export Functionality (AC: 8) ✅ COMPLETED

  - [x] Create CSV export function for contact data using native JavaScript
  - [x] Add export button to contact list interface
  - [x] Implement client-side CSV generation with chunking for large datasets
  - [x] Add filtering options for export based on current view state
  - [x] Implement proper file naming with timestamps

- [x] Task 5: Enhanced API Functions (All ACs) ✅ COMPLETED

  - [x] Extend contacts.ts with search and pagination functions
  - [x] Add updateContact mutation for editing capabilities
  - [x] Implement getContactById query for detail view
  - [x] Add proper input validation and error handling

- [x] Task 6: Testing Implementation (All ACs) ✅ COMPLETED

  - [x] Comprehensive user testing for ContactList, ContactDetail, and ContactEdit components
  - [x] Integration testing for search and filter functionality  
  - [x] End-to-end testing for complete contact management workflow
  - [x] CSV export functionality testing
  - [x] Real-time updates testing across browser tabs
  - [x] Error handling testing (invalid IDs, network issues, validation)
  - [x] Next.js 15 compatibility testing
  - [x] All acceptance criteria validated through systematic user testing

## Dev Notes

### Previous Story Insights

From Story 1.1 completion notes:

- Basic lead capture form already implemented with LeadCaptureForm component
- Contact model exists in Convex schema with proper enumerations
- Contacts page already created but needs enhancement beyond basic form
- Navigation system in place with role-based menu items
- Authentication and authorization system fully functional

### Data Models

**Contact Model** [Source: architecture/data-models.md#Contact]

- Core entity for lead management
- Required fields: name, email, leadSource, leadHeat, status
- Status enumeration: UNQUALIFIED, PROSPECT, LEAD, QUALIFIED, CUSTOMER, LOST
- LeadSource enumeration: WEBSITE, FACEBOOK, INSTAGRAM, LINKEDIN, REFERRAL, DIRECT, OTHER
- Optional fields: phone, company, notes, assignedTo
- Timestamps: createdAt, updatedAt

**Existing Contact Interface from Convex Schema:**

```typescript
interface Contact {
  _id: Id<"contacts">;
  name: string;
  email: string;
  phone?: string;
  company?: string;
  leadSource:
    | "WEBSITE"
    | "FACEBOOK"
    | "INSTAGRAM"
    | "LINKEDIN"
    | "REFERRAL"
    | "DIRECT"
    | "OTHER";
  leadHeat: "COLD" | "WARM" | "HOT";
  status:
    | "UNQUALIFIED"
    | "PROSPECT"
    | "LEAD"
    | "QUALIFIED"
    | "CUSTOMER"
    | "LOST";
  notes?: string;
  assignedTo?: Id<"users">;
  createdAt: number;
  updatedAt: number;
}
```

### API Specifications

**tRPC Router Structure** [Source: architecture/backend-architecture.md#tRPC]

- Located in `src/server/api/routers/`
- Contact router: contact.ts with create, read operations
- Protected procedures require authentication middleware
- Must extend existing contact.ts router with new functionality

**Existing Convex Functions** [Source: Story 1.1 completion notes]

- `createContact` mutation - already implemented
- `getAllContacts` query - already implemented
- `getContactByEmail` query - already implemented
- `updateContactStatus` mutation - already implemented
- `assignContact` mutation - already implemented

**New Functions Needed:**

- `getContactById` query for detail view
- `searchContacts` query with search and filter parameters
- `updateContact` mutation for editing contact information
- Pagination support in getAllContacts query

### Component Specifications

**Form Components** [Source: architecture/frontend-architecture.md#Component]

- Use react-hook-form for form handling
- Located in `src/components/forms/`
- Follow component template with TypeScript interfaces
- Use shadcn/ui base components

**Contact Management Module** [Source: architecture/components.md#Contact-Management-Module]

- Contact list with filtering and search
- Contact detail view with interaction timeline
- Lead heat visualization
- Dependencies: tRPC contact router, Convex Contact model
- Technology Stack: React Server Components, shadcn/ui, Zustand for UI state

### Data Flow Architecture

**Component → Data Pattern:**

```typescript
// Use direct Convex queries/mutations (recommended for real-time)
const contacts = useQuery(api.contacts.getAllContacts);
const updateContact = useMutation(api.contacts.updateContact);

// NOT through tRPC layer (tRPC used for business logic endpoints only)
```

**Real-time Updates Implementation:**

- Convex provides automatic reactivity - components re-render on data changes
- Use optimistic updates for edit operations with proper error handling
- No additional WebSocket setup required - Convex handles this automatically
- Handle concurrent edit conflicts by refreshing data on mutation errors

**State Management Scope:**

- Convex handles all server state (contacts data, real-time updates)
- Local state needed for: search filters, pagination offset, edit modes, selected items
- Consider URL state for shareable filtered views (e.g., `?search=john&status=LEAD`)
- Use Zustand only for complex UI state that needs cross-component sharing

**CSV Export Architecture:**

- Client-side generation using native JavaScript (no external library needed for basic CSV)
- Data transformation pipeline: Filter → Map → CSV stringify → Download
- Memory considerations: Process in chunks for large datasets (>1000 contacts)
- File naming convention: `contacts-export-${timestamp}.csv`
- Export filtered results based on current view state

### File Locations

**Project Structure** [Source: architecture/unified-project-structure.md]

- Components: `src/components/features/contacts/`
- Contact pages: `src/app/(dashboard)/contacts/`
- Contact router: `src/server/api/routers/contact.ts`
- Convex functions: `convex/contacts.ts`
- Contact utilities: `src/lib/utils/contacts.ts`

**Specific File Locations for Implementation:**

- ContactList component: `src/components/features/contacts/ContactList.tsx`
- ContactDetail component: `src/components/features/contacts/ContactDetail.tsx`
- ContactEdit component: `src/components/features/contacts/ContactEdit.tsx`
- Contact detail page: `src/app/(dashboard)/contacts/[id]/page.tsx`
- Enhanced contacts page: `src/app/(dashboard)/contacts/page.tsx`

### Testing Requirements

**Testing Strategy** [Source: architecture/testing-strategy.md]

- Unit tests with Vitest + React Testing Library
- E2E tests with Playwright
- Backend tests for tRPC procedures
- Test files location: `tests/` directory
- Component tests: `tests/components/contacts/`
- API tests: `tests/api/contact.test.ts`
- E2E tests: `e2e/contacts.spec.ts`

**Specific Testing Requirements for Contact Management:**

- Test search functionality with various inputs
- Test filter combinations and edge cases
- Test pagination navigation and data loading
- Test contact editing with form validation
- Test CSV export with different data sets
- Test real-time updates when contacts change

### Technical Constraints

**Technology Stack** [Source: architecture/tech-stack.md]

- Next.js 15.x with App Router
- TypeScript 5.x for type safety
- Convex for database and real-time features
- shadcn/ui for component library
- Tailwind CSS 3.x for styling

**Environment Configuration** [Source: architecture/development-workflow.md]

- Use existing Convex deployment configuration
- Real-time subscriptions through Convex
- Authentication through existing Clerk integration

**Coding Standards** [Source: architecture/coding-standards.md]

- Always use TypeScript interfaces, never `any` type
- All API endpoints through tRPC routers with input validation
- Never query database directly from components
- Check user permissions in protected tRPC procedures
- Use Convex real-time subscriptions, not polling
- Component naming: PascalCase (e.g., `ContactList.tsx`)
- Hook naming: camelCase with 'use' prefix (e.g., `useContacts.ts`)

## Testing

### Testing Standards

**Test File Locations** [Source: architecture/testing-strategy.md#Test-Organization]

- Component tests: `tests/components/contacts/`
- API tests: `tests/api/`
- E2E tests: `e2e/`

**Testing Frameworks** [Source: architecture/testing-strategy.md#Testing-Pyramid]

- Frontend: Vitest + React Testing Library
- Backend: Vitest + Convex test utilities
- E2E: Playwright

**Specific Testing Requirements**

- Test contact search with partial matches and special characters
- Test filter combinations and reset functionality
- Test pagination edge cases (empty results, single page)
- Test contact editing validation and error states
- Test CSV export data accuracy and format
- E2E test for complete contact management workflow from creation to editing

## Change Log

| Date       | Version | Description                                                                                                                           | Author              |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| 2025-08-03 | 1.0     | Initial story creation for contact management dashboard                                                                               | Bob (Scrum Master)  |
| 2025-08-03 | 1.1     | Enhanced Dev Notes with Data Flow Architecture, real-time implementation details, state management scope, and CSV export architecture | Winston (Architect) |
| 2025-08-03 | 1.2     | **IMPLEMENTATION PROGRESS**: Completed Tasks 1, 4, and 5. Implemented enhanced ContactList with search dropdown, filtering, pagination, CSV export, and new Convex API functions. Fixed search UX issue and separated name/phone columns. | Claude Code |
| 2025-08-03 | 1.3     | **IMPLEMENTATION PROGRESS**: Completed Tasks 2 and 3. Implemented ContactDetail component with comprehensive info display, interaction timeline, breadcrumb navigation, and ContactEdit component with form validation and save/cancel functionality. | Claude Code |
| 2025-08-03 | 1.4     | **IMPLEMENTATION COMPLETE**: Fixed Next.js 15 async params issue, Convex ID validation, and error handling UI. All 6 tasks completed successfully. Story ready for production deployment. Comprehensive user testing passed. | Claude Code |
